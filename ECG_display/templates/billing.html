{% load static %}
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Оплата функцій</title>
  <meta name="description" content="Оберіть функції та сплатіть підписку" />
  <style>
    :root{
      --bg:#0b0f14; --fg:#eaf2ff; --muted:#a1b3c9; --brand:#6ee7ff; --accent:#a78bfa;
      --border:rgba(255,255,255,.12); --card:rgba(255,255,255,.06); --glass:rgba(255,255,255,.08);
      --shadow:0 20px 60px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.3);
      --ok:#21f6a1; --warn:#ffd85c; --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial; color:var(--fg);
      background:
        radial-gradient(1200px 600px at 10% -10%, #18304a 0%, transparent 60%),
        radial-gradient(1000px 500px at 110% 0%, #3a1c66 0%, transparent 55%),
        radial-gradient(900px 800px at -10% 120%, #0e515f 0%, transparent 70%),
        var(--bg);
      overflow-x:hidden;
    }
    header{position:sticky; top:0; z-index:40; backdrop-filter:saturate(170%) blur(12px); background:rgba(11,15,20,.6); border-bottom:1px solid var(--border)}
    .nav{max-width:1100px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between; height:64px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--fg); font-weight:700}
    .brand img{height:36px; width:auto}
    .nav a{color:var(--fg); text-decoration:none; opacity:.9; padding:8px 10px; border-radius:12px}
    .nav a:hover{background:var(--card); opacity:1}

    main{max-width:1100px; margin:0 auto; padding:28px 20px 60px}
    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:18px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--glass); border:1px solid var(--border); border-radius:22px; padding:18px; box-shadow:var(--shadow)}
    .card h1{margin:0 0 6px; font-size:28px}
    .card p.sub{margin:0; color:var(--muted)}

    .features{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:14px}
    @media (max-width: 700px){ .features{grid-template-columns:1fr} }

    .feat{display:grid; grid-template-columns:24px 1fr auto; align-items:center; gap:10px; padding:14px; border-radius:16px; border:1px solid var(--border); background:var(--card)}
    .feat h3{margin:0; font-size:16px}
    .feat p{margin:2px 0 0; color:var(--muted); font-size:13px}
    .price{white-space:nowrap; text-align:right}
    .muted{color:var(--muted)}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.04)}

    .summary{position:sticky; top:84px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .input, select{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:var(--fg)}

    .plan{display:flex; gap:8px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:6px}
    .plan input{display:none}
    .plan label{padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--fg)}
    .plan input:checked + label{background:var(--glass)}

    .total{display:flex; align-items:flex-end; justify-content:space-between; margin-top:12px}
    .total strong{font-size:24px}

    .btn{--br:linear-gradient(120deg, var(--brand), var(--accent)); width:100%; display:inline-flex; align-items:center; justify-content:center; gap:.6rem; padding:14px 18px; border-radius:16px; text-decoration:none; color:#081116; font-weight:700; letter-spacing:.3px; background:var(--br); box-shadow:var(--shadow); border:0; cursor:pointer}
    .btn:hover{filter:saturate(1.12)}
    .btn-ghost{color:var(--fg); background:transparent; border:1px solid var(--border)}
    .err{color:var(--err); font-size:14px; margin:6px 0 0}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a href="{% url 'home' %}" class="brand" aria-label="Головна">
        <img src="{% static 'img/logo.png' %}" alt="Лого"/>
        <span>Анестезіо&nbsp;симулятор</span>
      </a>
      <nav>
        <a href="{% url 'profile' %}">Профіль</a>
        <a href="{% url 'logout' %}">Вийти</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Ліва: перелік функцій -->
      <section class="card">
        <h1>Оплата функцій</h1>
        <p class="sub">Оберіть потрібні модулі. Оплата помісячно або раз на рік зі знижкою.</p>

        {% if messages %}
          {% for m in messages %}<p class="{{ m.tags }}">{{ m }}</p>{% endfor %}
        {% endif %}

        <div class="features" id="featureList">
          {% for f in features %}
          <label class="feat">
            <input type="checkbox" name="feature_ids" value="{{ f.id }}" {% if f.already_active %}disabled{% endif %}
                   data-month="{{ f.price_month|default:0 }}" data-year="{{ f.price_year|default:0 }}"
                   data-title="{{ f.title }}">
            <div>
              <h3>
                {{ f.title }}
                {% if f.already_active %}<span class="badge">Вже активовано</span>{% endif %}
              </h3>
              <p>{{ f.description }}</p>
            </div>
            <div class="price">
              <div class="muted"><span class="pm">{{ f.price_month|default:0 }} грн/міс</span></div>
              <div class="muted"><span class="py">{{ f.price_year|default:0 }} грн/рік</span></div>
            </div>
          </label>
          {% empty %}
            <p class="muted">Немає доступних функцій.</p>
          {% endfor %}
        </div>
      </section>

      <!-- Права: кошик/сума та форма -->
      <aside class="card summary">
        <form method="post" action="{% url 'billing_checkout' %}" id="checkoutForm">
          {% csrf_token %}

          <div class="row" style="margin-bottom:10px">
            <div>
              <div class="plan">
                <input type="radio" name="period" id="p-month" value="month" checked>
                <label for="p-month">Помісячно</label>
                <input type="radio" name="period" id="p-year" value="year">
                <label for="p-year">Річна (зі знижкою)</label>
              </div>
            </div>
            <div>

            </div>
          </div>

          <div id="cart" class="card" style="background:rgba(255,255,255,.04); border-radius:16px; padding:12px; margin-bottom:12px">
            <div class="row" style="margin-bottom:6px"><strong>Обрані функції</strong><span class="muted" id="count">0</span></div>
            <ul id="items" style="list-style:none; padding:0; margin:0"></ul>
          </div>

          <label class="muted" for="coupon">Промокод (опційно)</label>
          <input class="input" type="text" name="coupon" id="coupon" placeholder="PROMO2025" />

          <div class="total">
            <span class="muted">До сплати</span>
            <strong id="total">0 грн</strong>
          </div>

          <input type="hidden" name="feature_ids_joined" id="feature_ids_joined" />
          <input type="hidden" name="amount_minor" id="amount_minor" />

          <label style="display:flex; align-items:center; gap:8px; margin:10px 0">
            <input type="checkbox" required name="agree"> <span class="muted">Погоджуюсь з умовами оферти</span>
          </label>

          {% if form_errors %}<div class="err">{{ form_errors }}</div>{% endif %}
          <button class="btn" type="submit">Перейти до оплати</button>

          <p class="muted" style="margin-top:10px">Оплата захищена. Фактична сума може незначно відрізнятись через курси валют та комісію платіжної системи.</p>
        </form>
      </aside>
    </div>
  </main>

  <script>
    (function(){
      const list = document.getElementById('featureList');
      const items = document.getElementById('items');
      const totalEl = document.getElementById('total');
      const countEl = document.getElementById('count');
      const joined = document.getElementById('feature_ids_joined');
      const amountMinor = document.getElementById('amount_minor');
      const form = document.getElementById('checkoutForm');

      function getPeriod(){
        return (form.querySelector('input[name="period"]:checked')||{}).value || 'month';
      }

      function formatUAH(n){
        try{ return new Intl.NumberFormat('uk-UA', {style:'currency', currency:'UAH', maximumFractionDigits:0}).format(n); }
        catch(e){ return n + ' грн'; }
      }

      function recalc(){
        const period = getPeriod();
        const picked = Array.from(list.querySelectorAll('input[type="checkbox"]:checked'));
        items.innerHTML = '';
        let sum = 0;
        picked.forEach(cb=>{
          const li = document.createElement('li');
          li.style.display='flex'; li.style.justifyContent='space-between'; li.style.padding='6px 0';
          const title = cb.dataset.title;
          const price = Number(cb.dataset[period]||0);
          sum += price;
          li.innerHTML = `<span>${title}</span><span class="muted">${price} грн/${period==='month'?'міс':'рік'}</span>`;
          items.appendChild(li);
        });
        totalEl.textContent = formatUAH(sum);
        countEl.textContent = picked.length;
        joined.value = picked.map(cb=>cb.value).join(',');
        amountMinor.value = Math.round(sum * 100); // копійки
      }

      list.addEventListener('change', recalc);
      form.addEventListener('change', (e)=>{
        if(e.target.name==='period'){ recalc(); }
      });
      recalc();
    })();
  </script>
</body>
</html>
